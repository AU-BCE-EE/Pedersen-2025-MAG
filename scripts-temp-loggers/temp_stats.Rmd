---
title: 'Linear model analysis for temperature difference size'
output: pdf_document
author: 
date: "`r Sys.time()`"
---

```{r}
library(viridisLite)
```

Temperature difference.

```{r}
d2$dtemp <- d2$Itemp - d2$Otemp
```

```{r}
fit1 <- lm(Itemp ~ poly(glorad, 3) + poly(Otemp, 3) + poly(wv2, 3), data = d2)
fit2 <- lm(dtemp ~ poly(glorad, 3) + poly(Otemp, 3) + poly(wv2, 3), data = d2)
```

Check results

```{r}
summary(fit1)
summary(fit2)
```

Temperature difference model is better--lower residual standard error.
(R-squared is lower but that is just because we have already removed a lot of the variation by calculating a difference.)

Let's generate scaled predictor variables for standardized coefficients (relative to 1 standard deviation of predictor variable).
This will show which predictors are the most important compared to how much they vary.

```{r}
fit3 <- lm(dtemp ~ poly(scale(glorad), 3) + poly(scale(Otemp), 3) + poly(scale(wv2), 3), data = d2)
```

```{r}
summary(fit3)
```

It looks like temperature (`Otemp`) is the most important.
Is that supported by the measurements?

```{r}
pairs(d2[, .(Otemp, glorad, wv2, dtemp)])
```

Seem so, yes.

Let's see how much worse the model is without the other two.

```{r}
fit4 <- lm(dtemp ~ poly(Otemp, 3), data = d2)
```

```{r}
summary(fit4)
```

It is almost the same as 2.
So effects of radiation and wind look small, surprisingly.

Generate predictions for plotting.

```{r}
d2$Itemp.pred <- predict(fit1)
d2$dtemp.pred2 <- predict(fit2)
d2$dtemp.pred4 <- predict(fit4)
```

And take a look.

```{r}
ggplot(d2, aes(Otemp, dtemp, colour = glorad)) + 
  geom_line(aes(Otemp, dtemp.pred2), colour = 'blue') + 
  geom_line(aes(Otemp, dtemp.pred4), colour = 'red') + 
  geom_point() + 
  scale_color_viridis_c(option = 'magma') +
  theme_bw() +
  xlab('Ambient soil surface temperature (C)') + ylab('DFC soil surface temperature (C)')
```

So, temperature alone indeed does as well as the most complete model.
But both miss a lot of the variation.
How about effects of earlier weather?
For that we need to add lagged predictor variables.
Try previous hour.

```{r}
wthr <- unique(d2[, .(t.start, Otemp, glorad, wv2)])
wthr[, t.start := t.start - 3600]
d2 <- merge(d2, wthr, by = 't.start', suffixes = c('', '.lag1'))
wthr[, t.start := t.start - 3600]
d2 <- merge(d2, wthr, by = 't.start', suffixes = c('', '.lag2'))
```

```{r}
fit5 <- lm(dtemp ~ poly(glorad, 3) + poly(Otemp, 3) + poly(wv2, 3) + poly(glorad.lag1, 3) + poly(Otemp.lag1, 3) + poly(wv2.lag1, 3), data = d2)
summary(fit5)
summary(fit2)
```

Not a lot of improvement really.

```{r}
d2$dtemp.pred5 <- predict(fit5)
```

```{r}
ggplot(d2, aes(Otemp, dtemp, colour = glorad)) + 
  geom_line(aes(Otemp, dtemp.pred2), colour = 'blue') + 
  geom_line(aes(Otemp, dtemp.pred4), colour = 'red') + 
  geom_line(aes(Otemp, dtemp.pred5), colour = 'orange') + 
  geom_point() + 
  scale_color_viridis_c(option = 'magma') +
  theme_bw() +
  xlab('Ambient soil surface temperature (C)') + ylab('DFC soil surface temperature (C)')
```

```{r}
ggplot(d2) +
  geom_point(aes(dtemp, dtemp.pred2), colour = 'blue', alpha = 0.2) +
  geom_point(aes(dtemp, dtemp.pred4), colour = 'red', alpha = 0.2) +
  geom_point(aes(dtemp, dtemp.pred5), colour = 'orange', alpha = 0.2) +
  theme_bw() 
```

```{r}
newdat <- expand.grid(glorad = 0:10 * 100, Otemp = 0:10 * 3, wv2 = 2)
setDT(newdat)
newdat$dtemp.pred5 <- predict(fit2, newdata = newdat)
newdat[dtemp.pred5 > 5, ]
```

Looks at some subsets.

```{r}
newdat[dtemp.pred5 > 3, ]
newdat[dtemp.pred5 > 5, ]
newdat[dtemp.pred5 > 8, ]
```


