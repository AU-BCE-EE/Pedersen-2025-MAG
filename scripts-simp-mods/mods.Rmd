---
title: 'Simple models'
author: 'Sasha D. Hafner'
date: "`r format(Sys.time(), '%H:%M - %d %B, %Y')`"
---

# Structure/replication

Check for replication by slurry ID x trial ID.
And number of digestate and raw slurries.

```{r}
table(ds[, .(slurry.ID, trial.ID)])
table(ds[, .(slurry.type, trial.ID)])
```

# Exploratory plots and correlation

Scatterplots to look for correlation between emission and predictor variables and between predictor variables.

```{r}
pairs(ds[, .(pH.lab.mn, TS.mn, area.perc.mn, logK, n.mn, mm1.mn, mm2.mn, e.rel.150)], col = ds$col, pch = 19)
```

Pearson's r.
`dsd` is digestate only and `dsr` is raw slurry only.
`ds` is everything.

```{r}
cor(ds[, .(pH.lab.mn, TS.mn, area.perc.mn, logK, n.mn, mm1.mn, mm2.mn, e.rel.150)])
cor(dsd[, .(pH.lab.mn, TS.mn, area.perc.mn, logK, n.mn, mm1.mn, mm2.mn, e.rel.150)])
cor(dsr[, .(pH.lab.mn, TS.mn, area.perc.mn, logK, n.mn, mm1.mn, mm2.mn, e.rel.150)])
```

# Models - combined slurry types

## F. Slurry type models

```{r}
lm_f1 <- lm(e.rel.150 ~ slurry.type, data = ds)
summary(lm_f1)
drop1(lm_f1, test = 'F')
```

```{r}
mm_f1 <- lmer(e.rel.150 ~ slurry.type + (1|trial.ID) + (1|slurry.ID), data = ds)
summary(mm_f1)
fixef(mm_f1)
drop1(mm_f1, test = 'Chisq')
```

Exclude intercept to get means.

```{r}
mm_f2 <- lmer(e.rel.150 ~ slurry.type + (1|trial.ID) + (1|slurry.ID) - 1, data = ds)
summary(mm_f2)
fixef(mm_f2)
drop1(mm_f2, test = 'Chisq')
```

```{r}
lm_f2 <- lm(e.rel.150 ~ slurry.type + trial.ID, data = ds)
summary(lm_f2)
drop1(lm_f2, test = 'F')
```

```{r}
lm_f3 <- aov(e.rel.150 ~ slurry.type, data = ds)
summary(lm_f3)
model.tables(lm_f3, type = 'means')
TukeyHSD(lm_f3, 'slurry.type')
```

## A. DM and pH
Hypothesize that DM and pH can explain emission.
`mm1.mn` is the only other variable not highly correlated with DM, so we include that too.


```{r}
mm_a1 <- lmer(e.rel.150 ~ TS.mn + pH.lab.mn + mm1.mn + (1|trial.ID) + (1|slurry.ID), data = ds)
summary(mm_a1)
fixef(mm_a1)
drop1(mm_a1, test = 'Chisq')
```

Drop slurry ID.

```{r}
mm_a2 <- lmer(e.rel.150 ~ TS.mn + pH.lab.mn + mm1.mn + (1|trial.ID), data = ds)
summary(mm_a2)
fixef(mm_a2)
drop1(mm_a2, test = 'Chisq')
```

No evidence of `mm1.mn` correlation so we'll drop it.

```{r}
mm_a3 <- lmer(e.rel.150 ~ TS.mn + pH.lab.mn + (1|trial.ID), data = ds)
summary(mm_a3)
fixef(mm_a3)
drop1(mm_a3, test = 'Chisq')
```

Pretty clear, and positive coefficients.

Check linear model.

```{r}
lm_a3 <- lm(e.rel.150 ~ TS.mn + pH.lab.mn, data = ds)
summary(lm_a3)
```

Same.

Add slurry type.

```{r}
mm_a4 <- lmer(e.rel.150 ~ TS.mn + pH.lab.mn + slurry.type + (1|trial.ID), data = ds)
summary(mm_a4)
fixef(mm_a4)
drop1(mm_a4, test = 'Chisq')
```

And try linear model with slurry type too.

```{r}
lm_a4 <- lm(e.rel.150 ~ TS.mn + pH.lab.mn + slurry.type, data = ds)
summary(lm_a4)
drop1(lm_a4, test = 'F')
```

Yes it does, but the fit does not improve much.

```{r}
summary(lm_f1)[c('r.squared', 'adj.r.squared')]
summary(lm_a3)[c('r.squared', 'adj.r.squared')]
summary(lm_a4)[c('r.squared', 'adj.r.squared')]
```

# B. ESA based models

```{r}
mm_b1 <- lmer(e.rel.150 ~ area.perc.mn + pH.lab.mn + mm1.mn + mm2.mn + (1|trial.ID) + (1|slurry.ID), data = ds)
summary(mm_b1)
fixef(mm_b1)
drop1(mm_b1, test = 'Chisq')
```

Drop slurry ID.

```{r}
mm_b2 <- lmer(e.rel.150 ~ area.perc.mn + pH.lab.mn + mm1.mn + mm2.mn + (1|trial.ID), data = ds)
summary(mm_b2)
fixef(mm_b2)
drop1(mm_b2, test = 'Chisq')
```

Go to `lm()` with no trial ID.


```{r}
lm_b3 <- lm(e.rel.150 ~ area.perc.mn + pH.lab.mn + mm1.mn + mm2.mn, data = ds)
summary(lm_b3)
drop1(lm_b3, test = 'F')
```

Try ESA alone.

```{r}
mm_b4 <- lmer(e.rel.150 ~ area.perc.mn + pH.lab.mn + (1|trial.ID), data = ds)
summary(mm_b4)
fixef(mm_b4)
drop1(mm_b4, test = 'Chisq')
```

```{r}
lm_b4 <- lm(e.rel.150 ~ area.perc.mn + pH.lab.mn, data = ds)
summary(lm_b4)
drop1(lm_b4, test = 'F')
```

We get a clear correlation and a decent fit here.
Of course the sign of the slope makes no sense.
Overall fit is identical to DM based model.

```{r}
summary(lm_a3)[c('r.squared', 'adj.r.squared')]
summary(lm_b4)[c('r.squared', 'adj.r.squared')]
```

# C. logK-based models

```{r}
mm_c1 <- lmer(e.rel.150 ~ logK + pH.lab.mn + mm1.mn + (1|trial.ID) + (1|slurry.ID), data = ds)
summary(mm_c1)
fixef(mm_c1)
drop1(mm_c1, test = 'Chisq')
```

Drop slurry.ID.

```{r}
mm_c2 <- lmer(e.rel.150 ~ logK + pH.lab.mn + mm1.mn + (1|trial.ID), data = ds)
summary(mm_c2)
fixef(mm_c2)
drop1(mm_c2, test = 'Chisq')
```

Particle predictor mm1.mn does not do much.

```{r}
mm_c3 <- lmer(e.rel.150 ~ logK + pH.lab.mn + (1|trial.ID), data = ds)
summary(mm_c3)
fixef(mm_c3)
drop1(mm_c3, test = 'Chisq')
```

And logK is not very useful.

# D. m/n models

```{r}
mm_d1 <- lmer(e.rel.150 ~ pH.lab.mn + n.mn + mm1.mn + (1|trial.ID), data = ds)
summary(mm_d1)
fixef(mm_d1)
drop1(mm_d1, test = 'Chisq')
```

Drop mm1.mn

```{r}
mm_d2 <- lmer(e.rel.150 ~ pH.lab.mn + n.mn + (1|trial.ID), data = ds)
summary(mm_d2)
fixef(mm_d2)
drop1(mm_d2, test = 'Chisq')
```

```{r}
lm_d3 <- lm(e.rel.150 ~ pH.lab.mn + n.mn, data = ds)
summary(lm_d3)
drop1(lm_d3, test = 'F')
```

This is best model so far, and simple.

Does slurry type add more info?


```{r}
lm_d4 <- lm(e.rel.150 ~ pH.lab.mn + n.mn + slurry.type, data = ds)
summary(lm_d4)
drop1(lm_d4, test = 'F')
```

Yes.

# F. Particle based models

```{r}
mm_e1 <- lmer(e.rel.150 ~ pH.lab.mn + mm1.mn + mm2.mn + (1|trial.ID), data = ds)
summary(mm_e1)
fixef(mm_e1)
drop1(mm_e1, test = 'Chisq')
```

```{r}
mm_e2 <- lmer(e.rel.150 ~ pH.lab.mn + mm2.mn + (1|trial.ID), data = ds)
summary(mm_e2)
fixef(mm_e2)
drop1(mm_e2, test = 'Chisq')
```

```{r}
lm_e3 <- lm(e.rel.150 ~ pH.lab.mn + mm2.mn, data = ds)
summary(lm_e3)
drop1(lm_e3, test = 'F')
```

Another good model.

Does slurry type add more info?

```{r}
lm_e4 <- lm(e.rel.150 ~ pH.lab.mn + mm2.mn + slurry.type, data = ds)
summary(lm_e4)
drop1(lm_e4, test = 'Chisq')
```

Nope, not clearly at least!

```{r}
mm_e5 <- lmer(e.rel.150 ~ pH.lab.mn + mm2.mn + slurry.type + (1|trial.ID), data = ds)
summary(mm_e5)
fixef(mm_e5)
drop1(mm_e5, test = 'Chisq')
```

Neat!

## Model predictions

Make predictions for plots.

```{r}
ds[, mm_a3.pred := predict(mm_a3)]
ds[, mm_d2.pred := predict(mm_d2)]
ds[, mm_f1.pred := predict(mm_f1)]
```

