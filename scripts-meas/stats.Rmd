---
title: 'Statistical analysis'
author: 'Sasha D. Hafner'
date: "`r format(Sys.time(), '%H:%M - %d %B, %Y')`"
---

# Data table
```{r}
setDT(isumm)
```

# Trials 1-4 (digestate treatment effects)

Subset.

```{r}
isumm1 <- isumm[new.ID %in% as.character(1:4)]
```

Separate digestate type from treatment

```{r}
isumm1[, dig.ID := substr(treat1, 1, 1)]
isumm1[, dig.treat := gsub('^[ABC]', '', treat1)]
```

Fit mixed-effects model and fixed-effects for comparison.

```{r}
m0 <- lm(e.rel.150 ~ dig.treat * dig.ID + new.ID, data = isumm1)
m1 <- lmer(e.rel.150 ~ dig.treat + (1|dig.ID) + (1|new.ID), data = isumm1)
m1notreat <- lmer(e.rel.150 ~ (1|dig.ID) + (1|new.ID), data = isumm1)
m1nodig <- lmer(e.rel.150 ~ dig.treat + (1|new.ID), data = isumm1)
m2 <- lmer(e.rel.150 ~ dig.treat + (1|dig.ID/dig.treat) + (1|new.ID), data = isumm1)
m3 <- lmer(e.rel.150 ~ treat1 + (1|new.ID), data = isumm1)
```

```{r}
summary(m0)
anova(m0)
```

```{r}
summary(m1)
summary(m2)
summary(m3)
```

Check for treatment effect and interaction with likelihood ratio test.

```{r}
anova(m1, m1notreat, test = 'Chisq')
anova(m1, m1nodig, test = 'Chisq')
anova(m2, m1, test = 'Chisq')
```

Plot to check.

```{r}
ggplot(isumm1, aes(dig.treat, e.rel.150, colour = dig.ID)) +
  geom_jitter(height = 0) +
  theme_bw()
```

```{r}
table(isumm1[, .(dig.ID, dig.treat)])
```

Major imbalance.
Get marginal means.

```{r}
emmeans(m3, 'treat1')
mmeans1_4 <- emmeans(m3, 'treat1')
mmeans1_4
```

```{r}
pairs(mmeans1_4)
```

Get letters.

```{r}
letters1_4 <- cld(object = mmeans1_4,
                  adjust = "Tukey",
                  Letters = letters,
                  alpha = 0.05)
letters1_4
```

Sort letters by treat1 and replace mmeans.

```{r}
mmeans1_4 <- letters1_4[order(letters1_4$treat1), ]
```

And get a column for copy/paste into paper.

```{r}
mmeans1_4$tabval <- paste(round(100 * mmeans1_4$emmean, 1), gsub(' ', '', mmeans1_4$.group))
```

Residuals.

```{r}
plot(fitted(m3), resid(m3))
abline(0,0)
qqnorm(resid(m3))
qqline(resid(m3))
```

# Trials 5-10 (app tech on winter wheat)

Subset.

```{r}
isumm1 <- droplevels(isumm[new.ID %in% c('5', '6', '7', '8', '9', '10') & !treat1 %in% c('TH-4', 'TS1-4')])
```

```{r}
table(isumm1[, .(new.ID, treat1)])
```

Close to balanced.

```{r}
ggplot(isumm1, aes(new.ID, e.rel.150, colour = treat1)) +
  geom_jitter(height = 0) +
  theme_bw()
```

Fit mixed-effects model.

```{r}
m1 <- lmer(e.rel.150 ~ treat1 + (1|new.ID), data = isumm1)
```

```{r}
summary(m1)
```

Marginal means.

```{r}
mmeans <- emmeans(m1, 'treat1')
mmeans
```

Need name for export.

Tukey's test

```{r}
mmeans5_10 <- emmeans(m1, 'treat1')
pairs(mmeans5_10)
```

```{r}
letters5_10 <- cld(object = mmeans5_10,
                  adjust = "Tukey",
                  Letters = letters,
                  alpha = 0.05)
letters5_10
```

```{r}
mmeans5_10 <- letters5_10[order(letters5_10$treat1), ]
```

And get a column for copy/paste into paper.

```{r}
mmeans5_10$tabval <- paste(round(100 * mmeans5_10$emmean, 1), gsub(' ', '', mmeans5_10$.group))
```


# Add 11-12

```{r}
isumm1 <- droplevels(isumm[new.ID %in% c('11', '12') & treat1 != 'TS1 + acid', ])
```

```{r}
table(isumm1[, .(new.ID, treat1)])
```

Completely balanced and only two experiments, so no need for mixed-effects model.

```{r}
m1 <- lm(e.rel.150 ~ treat1 + new.ID, data = isumm1)
```

```{r}
summary(m1)
```

Marginal means.

```{r}
mmeans <- emmeans(m1, 'treat1')
mmeans
```

Need name for export.

Tukey's test

```{r}
mmeans11_12 <- emmeans(m1, 'treat1')
pairs(mmeans11_12)
```

```{r}
letters11_12 <- cld(object = mmeans11_12,
                  adjust = "Tukey",
                  Letters = letters,
                  alpha = 0.05)
```

Order.

```{r}
mmeans11_12 <- letters11_12[c(3, 2, 1), ]
```

And get a column for copy/paste into paper.

```{r}
mmeans11_12$tabval <- paste(round(100 * mmeans11_12$emmean, 1), gsub(' ', '', mmeans11_12$.group))
```



9 and 10 driving speed may not have stats, may need it, section 3 supp
Relative differences there

supp sec 4, bands
hose distance, 13 and 14

chamber movement supp sec 5
trial 15

Then temperature stuff
Add to supporting material
